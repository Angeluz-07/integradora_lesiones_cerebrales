{% extends "base.html" %}

{% block navbar %}
            <section>
                <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                    <a class="navbar-brand px-4" href="#">Brain Lesion App</a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="d-flex justify-content-end collapse navbar-collapse" id="navbarNavDropdown">
                        <ul class="navbar-nav">             
                            <li class="nav-item">
                              <a class="nav-link" href="{% url 'diagnostic' 'new' %}">Diagnosticar</a>
                            </li>
                        </ul>
                        <ul class="navbar-nav">             
                            <li class="nav-item">
                              <a class="nav-link" href="{% url 'listDiagnostic' %}">Listar</a>
                            </li>
                        </ul>
                        <ul class="navbar-nav">             
                          <li class="nav-item">
                            <a class="nav-link" href="{% url 'listUser' %}">Usuarios</a>
                          </li>
                      </ul>
                        
                        <ul class="navbar-nav">             
                            <li class="nav-item">
                              <a class="nav-link" href="{% url 'logout' %}">Log out</a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </section> 
{% endblock %}

{% block content  %}
  <!--{% if user.is_authenticated and user.is_admin %}
    <h5>soy admin </h5>
    <h5>{{ user.name | upper }}</h5>
  {% else %}
    <h5>soy doctor</h5>
  {% endif %} -->


  <div class="row py-3">
      <!--div class="col-1">
          <label class="switch mt-5 mx-4">
            <input id="toggle-mask" type="checkbox" class="default">
            <span class="slider round"></span>
          </label>
      </div-->
      <div class="col-8">
          <div class="papaya" data-params="params"></div>
      </div>
      <div class="col-4">

        <div class="row">
          <div class="col-12 col-xl-12 d-flex justify-content-center align-items-center">
            <h5>Instrucciones</h5>
          </div>
        </div>
        <div class="row">
          <div class="col-2 col-xl-2"></div>
            <div class="col-8 col-xl-8 d-flex justify-content-center align-items-center">
              
              <p class="text-justify">Bienvenidos, esta aplicaciòn permite segmentar lesiones producto de ACV (Accidente Cerebrovascular) y determinar la clasificaciòn
              de la enfermedad cerebrovascular como: MCA o Lacunar. Para realizar esto el usuario tendrà que cargar un archivo MRI en formato NIfTI (.nii, nii.gz)
              y como resultado el usuario visualizarà el segmento generado junto con la imagen previamente cargada, si se detectò un lesiòn ACV. EL usuario puede guardar estos 
              resultados, si aprueba que son correctos, caso contrario, serà dirigido a un formulario donde podrà
              colocar su punto de vista sobre la informaciòn presentada por esta herramienta.</p>
                  
          </div>
          <div class="col-2 col-xl-2"></div>
        </div>
           
        {% include 'sub/cargarMRI.html' %}
          
      </div>
  </div>

{% endblock  %}


{% block specific_scripts %}

    <script type="text/javascript">

        var CSRFTOKEN = $("[name=csrfmiddlewaretoken]").val();
        var URL_LOAD_FILE = "{% url 'preload_file' %}" ;
        $('#fileMRI').change(function(){
          console.log('File loaded');
          console.log(this.files[0]);

          //Validate extension file
          var allowedExtensions = /(\.nii|\.nii\.gz)$/i;
          var filePath = this.files[0].name;
          if(!allowedExtensions.exec(filePath)){
            Swal.fire({
              icon: 'error',
              title: 'Archivo Inválido',
              text: 'Por favor, verifique que el archivo tenga extensión .nii o .nii.gz',
            })
            $("#fileMRI").val('');
            return false;
          }

          var fd = new FormData();
          var files = this.files[0];
          fd.append('fileMRI',files);
          $.ajax({
              url: URL_LOAD_FILE ,
              type: 'post',
              data: fd,
              contentType: false,
              processData: false,
              headers:{
                  "X-CSRFToken": CSRFTOKEN
              },
              success: function(response){
                console.log(response);
                
                var URL_ORIGINAL = `/file/${response['original']}`;
                console.log(URL_ORIGINAL);

                let params = [];
                params['showControlBar'] = true;
                params['images'] = [URL_ORIGINAL];
                papaya.Container.resetViewer(0, params);
              },
              error: function(err){
                console.log(err);
              },
           });

        });
    </script>
{% endblock %}
